<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover"/>
<title>Raiden and the Wing Chun Temple – Portrait</title>
<style>
  :root{--bg:#0b1420;--panel:#0f1a28;--panel2:#142235;--line:#2b3d55;--text:#fff}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
  #stage{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(--bg);}
  #canvas{display:block;image-rendering:pixelated;image-rendering:crisp-edges;background:var(--bg)}
  #ui{position:fixed;left:0;right:0;top:0;padding:12px;pointer-events:none}
  .hud{background:rgba(0,0,0,.35);border:1px solid var(--line);border-radius:14px;padding:10px 12px;max-width:min(520px,96vw);margin:0 auto}
  .tag{display:inline-block;background:var(--panel2);border:1px solid var(--line);border-radius:12px;padding:4px 8px;margin-right:8px;font-weight:700}
  .row{display:flex;align-items:center;gap:8px;margin-top:6px}
  .bar{flex:1;height:10px;background:#263241;border-radius:8px;overflow:hidden}
  .bar>i{display:block;height:100%;background:linear-gradient(90deg,#aaf,#7cf);width:0%}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:26%;background:rgba(0,0,0,.55);padding:8px 12px;border-radius:10px;font-weight:700;pointer-events:none}
  /* Mobile controls */
  #controls{position:fixed;left:0;right:0;bottom:0;background:rgba(20,30,48,.85);border-top:1px solid var(--line);padding:10px;display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between}
  .cluster{display:flex;gap:10px;flex-wrap:wrap}
  .btn{pointer-events:auto;touch-action:manipulation;background:#1b2533;border:1px solid var(--line);border-radius:16px;color:#fff;font-weight:800;
       min-width:64px;min-height:56px;padding:0 14px;display:flex;align-items:center;justify-content:center;user-select:none;letter-spacing:.3px}
  .wide{min-width:88px}
  @media (pointer:fine){#controls{display:none}}
  /* Menu */
  #menu{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(0,0,0,.6),rgba(0,0,0,.75));}
  .panel{pointer-events:auto;background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px 18px;max-width:480px;width:88%;box-shadow:0 10px 40px rgba(0,0,0,.35)}
  h1{margin:0 0 6px;font-size:22px}
  .sub{opacity:.85;margin:0 0 12px}
  .panel .row{justify-content:flex-start;flex-wrap:wrap}
  .panel button{pointer-events:auto;margin:6px 8px 0 0;padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:#1b2533;color:#fff;font-weight:800}
  .foot{font-size:12px;opacity:.7;margin-top:10px}
</style>
</head>
<body>
<!-- Audio hooks -->
<audio id="music_menu"    src="menu.mp3"     loop></audio>
<audio id="music_crane"   src="crane.mp3"    loop></audio>
<audio id="music_snake"   src="snake.mp3"    loop></audio>
<audio id="music_tiger"   src="tiger.mp3"    loop></audio>
<audio id="music_temple"  src="temple.mp3"   loop></audio>
<audio id="sfx_victory"   src="victory.mp3"></audio>
<audio id="sfx_gameover"  src="gameover.mp3"></audio>
<audio id="music_credits" src="credits.mp3"  loop></audio>

<div id="stage">
  <canvas id="canvas" width="540" height="960"></canvas>
</div>

<div id="ui">
  <div class="hud">
    <span class="tag">Stage: <b id="stageName">Crane: Balance</b></span>
    <span class="tag">Lessons: <b id="lessons">0/3</b></span>
    <div class="row"><div style="min-width:70px">Balance</div><div class="bar"><i id="bal"></i></div></div>
    <div class="row"><div style="min-width:70px">Focus</div><div class="bar"><i id="foc"></i></div></div>
    <div class="row"><div style="min-width:70px">Power</div><div class="bar"><i id="pow"></i></div></div>
  </div>
  <div class="toast" id="toast" style="opacity:0">Welcome!</div>
</div>

<!-- Menu -->
<div id="menu">
  <div class="panel">
    <h1>Raiden and the Wing Chun Temple</h1>
    <p class="sub">Portrait build — tap Play to begin your training.</p>
    <div class="row">
      <button id="playBtn">▶ Play</button>
      <button id="musicBtn">Music: On</button>
      <button id="creditsBtn">Credits</button>
    </div>
    <p class="foot">Controls: ◀ ▶ move · ⤒ jump · J punch · K interact · Space focus</p>
  </div>
</div>

<!-- Controls -->
<div id="controls">
  <div class="cluster">
    <div class="btn" data-k="ArrowLeft">◀</div>
    <div class="btn" data-k="ArrowRight">▶</div>
    <div class="btn wide" data-k="ArrowUp">⤒ Jump</div>
  </div>
  <div class="cluster">
    <div class="btn wide" data-k="Space">⏺ Focus</div>
    <div class="btn" data-k="KeyJ">J</div>
    <div class="btn" data-k="KeyK">K</div>
  </div>
</div>

<script>
(() => {
  // ====== Canvas auto-scale (portrait 540x960) ======
  const DESIGN_W = 540, DESIGN_H = 960;
  const cvs = document.getElementById('canvas'), ctx = cvs.getContext('2d');

  function resizeCanvas(){
    const vw = window.innerWidth, vh = window.innerHeight;
    const scale = Math.min(vw/DESIGN_W, vh/DESIGN_H);
    const cssW = Math.floor(DESIGN_W*scale), cssH = Math.floor(DESIGN_H*scale);
    const dpr = Math.min(window.devicePixelRatio||1, 3);
    const rW = Math.floor(cssW*dpr), rH = Math.floor(cssH*dpr);
    if (cvs.width!==rW || cvs.height!==rH){ cvs.width=rW; cvs.height=rH; }
    cvs.style.width=cssW+'px'; cvs.style.height=cssH+'px';
    ctx.setTransform(rW/DESIGN_W, 0, 0, rH/DESIGN_H, 0, 0);
  }
  resizeCanvas(); addEventListener('resize', resizeCanvas); addEventListener('orientationchange', resizeCanvas);

  // ====== Input (keys + on-screen) ======
  const keys = new Set();
  const mapKey = e => { const k=e.code; if(e.type==='keydown') keys.add(k); else keys.delete(k); };
  addEventListener('keydown', mapKey); addEventListener('keyup', mapKey);
  document.querySelectorAll('.btn').forEach(b=>{
    const k=b.dataset.k;
    const down=()=>{keys.add(k); b.style.transform='scale(.96)';};
    const up=()=>{keys.delete(k); b.style.transform='scale(1)';};
    b.addEventListener('pointerdown', down); addEventListener('pointerup', up);
    addEventListener('pointercancel', up); addEventListener('pointerleave', up);
  });

  // ====== HUD helpers ======
  const hud = {
    stageName: document.getElementById('stageName'),
    lessons: document.getElementById('lessons'),
    bal: document.getElementById('bal'),
    foc: document.getElementById('foc'),
    pow: document.getElementById('pow'),
    toast: document.getElementById('toast')
  };
  function toast(msg, dur=1800){ hud.toast.textContent=msg; hud.toast.style.opacity=1; setTimeout(()=>hud.toast.style.opacity=0, dur); }

  // ====== Audio control ======
  const a = {
    menu:    document.getElementById('music_menu'),
    crane:   document.getElementById('music_crane'),
    snake:   document.getElementById('music_snake'),
    tiger:   document.getElementById('music_tiger'),
    temple:  document.getElementById('music_temple'),
    victory: document.getElementById('sfx_victory'),
    gameover:document.getElementById('sfx_gameover'),
    credits: document.getElementById('music_credits'),
  };
  let musicOn = true;
  const playBtn = document.getElementById('playBtn');
  const musicBtn= document.getElementById('musicBtn');
  const creditsBtn=document.getElementById('creditsBtn');
  const menuOverlay=document.getElementById('menu');

  function stopAllMusic(){ [a.menu,a.crane,a.snake,a.tiger,a.temple,a.credits].forEach(x=>{ try{x.pause();}catch(e){} }); }
  function startTrack(x){ if(!musicOn||!x) return; x.currentTime=0; x.volume=0.85; x.play().catch(()=>{}); }
  // mobile unlock
  const unlock = ()=>{ a.menu.play().then(()=>a.menu.pause()).catch(()=>{}); window.removeEventListener('pointerdown', unlock); };
  window.addEventListener('pointerdown', unlock, {once:true});

  playBtn.onclick=()=>{ menuOverlay.style.display='none'; stopAllMusic(); startTrack(a.crane); };
  musicBtn.onclick=()=>{ musicOn=!musicOn; musicBtn.textContent='Music: '+(musicOn?'On':'Off'); if(!musicOn) stopAllMusic(); else startTrack(a.menu); };
  creditsBtn.onclick=()=>{ stopAllMusic(); startTrack(a.credits); alert('Credits music playing. Close to stop.'); stopAllMusic(); if(menuOverlay.style.display!=='none') startTrack(a.menu); };

  // Start menu music after small delay (user gesture may be needed)
  setTimeout(()=>startTrack(a.menu), 300);

  // ====== Sprite loading (4x4 sheet) ======
  const SPRITE_SRC = 'raiden-sprites.png'; // upload to repo root
  const sprite = new Image();
  let spriteReady=false;
  sprite.onload=()=>{ spriteReady=true; };
  sprite.onerror=()=>{ spriteReady=false; };
  sprite.src=SPRITE_SRC;

  const SPR_COLS = 4, SPR_ROWS = 4;
  // Frames: 0-3 idle, 4-7 punch, 8-11 walk, 12-15 jump
  function drawSpriteFrame(ix, x, y, w, h, facing=1){
    const fw = sprite.width/SPR_COLS, fh = sprite.height/SPR_ROWS;
    const sx = (ix%SPR_COLS)*fw, sy = Math.floor(ix/SPR_COLS)*fh;
    ctx.save();
    ctx.translate(x + (facing<0?w:0), y); ctx.scale(facing,1);
    ctx.drawImage(sprite, sx, sy, fw, fh, 0, 0, w, h);
    ctx.restore();
  }

  // ====== Game objects ======
  const groundY = 820;
  class Player{
    constructor(){ this.x=120; this.y=groundY-80; this.w=48; this.h=80; this.vx=0; this.vy=0; this.onGround=false; this.facing=1; this.comboT=0; this.animT=0; }
    step(dt){
      const sp = 190;
      if(keys.has('ArrowLeft')) { this.vx=-sp; this.facing=-1; } else if(keys.has('ArrowRight')) { this.vx=sp; this.facing=1; } else this.vx=0;
      if((keys.has('ArrowUp')) && this.onGround){ this.vy=-430; this.onGround=false; }
      this.vy += 1200*dt;
      this.x += this.vx*dt; this.y += this.vy*dt;
      if(this.y+this.h>=groundY){ this.y=groundY-this.h; this.vy=0; this.onGround=true; }
      if(keys.has('KeyJ')) this.comboT=0.25;
      this.comboT=Math.max(0, this.comboT-dt);
      this.animT+=dt;
    }
    draw(){
      if(spriteReady){
        let frame=0;
        if(!this.onGround) frame = 12 + Math.floor((this.animT*8)%4);
        else if(this.comboT>0) frame = 4 + Math.floor((this.animT*12)%4);
        else if(Math.abs(this.vx)>1) frame = 8 + Math.floor((this.animT*10)%4);
        else frame = Math.floor((this.animT*6)%4);
        drawSpriteFrame(frame, this.x|0, this.y|0, this.w, this.h, this.facing);
      } else {
        // fallback rectangle
        ctx.fillStyle='#f2b429'; ctx.fillRect(this.x, this.y, this.w, this.h);
      }
    }
  }
  const player = new Player();

  // Simple objects for Stage 0-3
  const npcs=[
    {stage:0,name:'Crane',x:420,y:groundY-60,color:'#a3e635',line:'"Balance brings structure."'},
    {stage:1,name:'Snake',x:420,y:groundY-60,color:'#22d3ee',line:'"Focus. Flow. Be still and sharp."'},
    {stage:2,name:'Tiger',x:420,y:groundY-68,color:'#f59e0b',line:'"Power lives inside you."'},
    {stage:3,name:'Master',x:320,y:groundY-70,color:'#f472b6',line:'"Wing Chun is here — in your heart."'}
  ];
  const obstacles={
    0:[{x:80,w:380,type:'log'}],
    1:[{x:70,w:120,type:'spike'},{x:240,w:140,type:'spike'},{x:380,w:80,type:'spike'}],
    2:[{x:120,w:40,type:'boulder'},{x:260,w:40,type:'boulder'},{x:360,w:120,type:'gate'}],
    3:[]
  };

  function drawBG(stage){
    // gradient
    const g=ctx.createLinearGradient(0,0,0,DESIGN_H);
    if(stage===0){g.addColorStop(0,'#0c1b2e');g.addColorStop(1,'#122339');}
    if(stage===1){g.addColorStop(0,'#0a1c17');g.addColorStop(1,'#14332b');}
    if(stage===2){g.addColorStop(0,'#1a1111');g.addColorStop(1,'#2b1a1a');}
    if(stage===3){g.addColorStop(0,'#0f1b2b');g.addColorStop(1,'#18324f');}
    ctx.fillStyle=g; ctx.fillRect(0,0,DESIGN_W,DESIGN_H);
    // ground
    ctx.fillStyle='#1e293b'; ctx.fillRect(0, groundY, DESIGN_W, DESIGN_H-groundY);
    ctx.fillStyle='#334155'; ctx.fillRect(0, groundY, DESIGN_W, 6);
    if(stage===0){ // water + log
      ctx.fillStyle='#1d4ed8'; ctx.fillRect(40, groundY+6, DESIGN_W-80, 16);
      ctx.fillStyle='#6b4f2d'; ctx.fillRect(obstacles[0][0].x, groundY-10, obstacles[0][0].w, 10);
    }
  }
  function drawNPC(n){ ctx.save(); ctx.translate(n.x,n.y); ctx.fillStyle=n.color; ctx.fillRect(-10,-20,20,20); ctx.fillStyle='#222'; ctx.fillRect(-12,0,24,4); ctx.restore(); }
  function aabb(a,b){ return !(a.x+a.w<b.x||a.x>b.x+b.w||a.y+a.h<b.y-b.h||a.y>b.y); }

  // ====== Stage logic ======
  const state={stage:0,lessons:0,balance:50,focus:0,power:0};
  function stageName(i){ return ['Crane: Balance','Snake: Focus','Tiger: Power','Temple: Master'][i]; }
  function nextStage(){ state.stage=Math.min(3,state.stage+1); hud.stageName.textContent=stageName(state.stage); player.x=120; player.y=groundY-80; toast(state.stage<3?'New lesson ahead.':'You found the Wing Chun Temple.'); stopAllMusic(); if(state.stage===1) startTrack(a.snake); if(state.stage===2) startTrack(a.tiger); if(state.stage===3) startTrack(a.temple); }

  // ====== Loop ======
  let last=performance.now();
  function loop(now){
    const dt=Math.min(0.033,(now-last)/1000); last=now;
    // mechanics
    if(state.stage===0){
      const log=obstacles[0][0];
      const onLog = (player.x+player.w>log.x && player.x<log.x+log.w && player.onGround);
      if(onLog){
        state.balance += Math.sin(now*0.004)*0.4;
        if(keys.has('ArrowLeft')) state.balance -= 0.6;
        if(keys.has('ArrowRight')) state.balance += 0.6;
        state.balance = Math.max(0, Math.min(100, state.balance));
        if(state.balance<5 || state.balance>95){ player.y=groundY-80; player.x=log.x-30; state.balance=50; toast('Wobble… steady yourself!'); }
      }
    }
    if(state.stage===1){ state.focus = Math.max(0, Math.min(100, state.focus + (keys.has('Space')?45*dt:-25*dt))); }
    if(state.stage===2){ state.power = Math.max(0, Math.min(100, state.power + (keys.has('KeyK')?60*dt:-40*dt))); }

    player.step(dt);

    // hazards interactions
    const obs=obstacles[state.stage];
    for(const o of obs){
      if(state.stage===1 && o.type==='spike'){
        const flashing = Math.floor(now/600)%2===0;
        if(flashing && aabb({x:player.x,y:player.y,w:player.w,h:player.h},{x:o.x,y:groundY,w:o.w,h:28})){
          if(state.focus<70){ player.x=120; toast('Be still and sharp. (Space to focus)'); }
        }
      }
      if(state.stage===2){
        if(o.type==='boulder' && Math.abs(player.x-o.x)<36 && state.power>65){ o.x+=120; toast('Inner power moves mountains!'); }
        if(o.type==='gate' && Math.abs(player.x-(o.x+o.w/2))<40 && state.power>80){ o.w=Math.max(0,o.w-160); toast('Gate yields to calm strength.'); }
      }
    }

    // reach NPC
    const npc = npcs.find(n=>n.stage===state.stage);
    if(npc && Math.abs(player.x-npc.x)<40){
      if(state.stage===0 && state.balance>=45 && state.balance<=55){ state.lessons++; toast(npc.line); nextStage(); }
      else if(state.stage===1 && state.focus>=80){ state.lessons++; toast(npc.line); nextStage(); }
      else if(state.stage===2 && state.power>=80){ state.lessons++; toast(npc.line); nextStage(); }
      else if(state.stage===3){ toast(npc.line+'\\nCalm. Proud. Strong.'); }
    }

    // draw
    drawBG(state.stage);
    drawNPC(npc);
    player.draw();

    hud.lessons.textContent = state.lessons+'/3';
    hud.bal.style.width = (state.balance|0)+'%';
    hud.foc.style.width = (state.focus|0)+'%';
    hud.pow.style.width = (state.power|0)+'%';
    requestAnimationFrame(loop);
  }
  hud.stageName.textContent=stageName(state.stage);
  toast('Stage 1: Keep balance ~50% and meet the Crane.');
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
