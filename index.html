<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
<title>Raiden and the Wing Chun Temple — Portrait</title>
<style>
  :root{--bg:#0b1220;--panel:#0f1b2b;--panel2:#121f33;--ink:#e6ecff}
  html,body{margin:0;height:100%;background:var(--bg);color:#fff;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
  #stage{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(--bg)}
  #canvas{display:block;image-rendering:pixelated}
  #hud{position:fixed;left:12px;top:12px;background:rgba(0,0,0,.35);padding:10px;border-radius:12px;backdrop-filter:blur(2px);}
  .row{display:flex;gap:8px;align-items:center}
  .token{display:inline-block;background:rgba(0,0,0,.35);border:1px solid #2b3a56;border-radius:10px;padding:4px 8px;margin-right:8px}
  .bar{height:10px;background:#273449;border-radius:6px;overflow:hidden;margin:6px 0;width:280px}
  .bar>i{display:block;height:100%;background:linear-gradient(90deg,#b7c6ff,#7fb3ff);width:0%}
  #controls{position:fixed;left:8px;right:8px;bottom:8px;display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between;pointer-events:none}
  .btn{pointer-events:auto;touch-action:manipulation;min-width:62px;min-height:52px;border-radius:14px;border:1px solid #2c3b56;background:#121d2c;color:#fff;font-weight:700;display:flex;align-items:center;justify-content:center}
  #menu{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.55)}
  .panel{background:#0e1726;border:1px solid #2b3a56;border-radius:16px; padding:16px 18px; max-width:540px; width:90%;}
  .panel h1{margin:0 0 8px;font-size:22px}
  .panel p{margin:0 0 12px;opacity:.9}
  .panel .actions{display:flex;gap:10px;flex-wrap:wrap}
  .panel button{pointer-events:auto;border:1px solid #2b3a56;background:#121d2c;color:#fff;border-radius:12px;padding:10px 14px;font-weight:700}
  .titleWrap{position:relative;display:flex;align-items:center;justify-content:center;margin:0 auto 10px;max-width:480px;aspect-ratio:1/1;border-radius:12px;overflow:hidden;background:linear-gradient(180deg,#0e1830,#0a1425)}
  .titleWrap img{display:block;width:100%;height:100%;object-fit:cover}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24%;background:rgba(0,0,0,.55);padding:8px 12px;border-radius:8px;font-weight:600;opacity:0;transition:opacity .2s}
</style>
</head>
<body>
<div id="stage"><canvas id="canvas" width="540" height="960"></canvas></div>

<!-- HUD -->
<div id="hud">
  <div><span class="token">Stage: <b id="stageName">Crane: Balance</b></span>
       <span class="token">Lessons: <b id="lessons">0/3</b></span></div>
  <div>Balance<div class="bar"><i id="balanceBar"></i></div></div>
  <div>Focus<div class="bar"><i id="focusBar"></i></div></div>
  <div>Power<div class="bar"><i id="powerBar"></i></div></div>
</div>

<!-- Mobile controls -->
<div id="controls">
  <div style="display:flex;gap:10px">
    <div class="btn" data-k="ArrowLeft">◀</div>
    <div class="btn" data-k="ArrowRight">▶</div>
    <div class="btn" data-k="Space">⏺ Focus</div>
  </div>
  <div style="display:flex;gap:10px">
    <div class="btn" data-k="KeyJ">J</div>
    <div class="btn" data-k="KeyK">K</div>
    <div class="btn" data-k="ArrowUp">↑</div>
  </div>
</div>

<!-- Title menu -->
<div id="menu">
  <div class="panel">
    <div class="titleWrap">
      <!-- If menu-title.png exists in repo, show it; otherwise we leave gradient bg -->
      <img id="menuArt" alt="Title art" />
    </div>
    <h1>Raiden and the Wing Chun Temple</h1>
    <p>Press Play to begin your training.</p>
    <div class="actions">
      <button id="playBtn">▶ Play</button>
      <button id="musicBtn">Music: On</button>
      <button id="creditsBtn">Credits</button>
    </div>
    <p style="font-size:12px;opacity:.75;margin-top:8px">Controls: arrows/WASD move & jump · J punch · K interact · Space focus</p>
  </div>
</div>

<div class="toast" id="toast">Welcome!</div>

<!-- Audio hooks (filenames to upload in repo root) -->
<audio id="aud_menu"   src="menu.mp3" loop></audio>
<audio id="aud_crane"  src="crane.mp3" loop></audio>
<audio id="aud_snake"  src="snake.mp3" loop></audio>
<audio id="aud_tiger"  src="tiger.mp3" loop></audio>
<audio id="aud_temple" src="temple.mp3" loop></audio>
<audio id="aud_vict"   src="victory.mp3"></audio>
<audio id="aud_over"   src="gameover.mp3"></audio>
<audio id="aud_cred"   src="credits.mp3" loop></audio>

<script>
(() => {
  // ---------- Canvas scaling (portrait 540x960 design) ----------
  const DESIGN_W=540, DESIGN_H=960;
  const cvs=document.getElementById('canvas'), ctx=cvs.getContext('2d');
  function resize(){
    const vw=window.innerWidth, vh=window.innerHeight;
    const scale=Math.min(vw/DESIGN_W, vh/DESIGN_H);
    const cssW=Math.floor(DESIGN_W*scale), cssH=Math.floor(DESIGN_H*scale);
    const dpr=Math.min(devicePixelRatio||1, 3);
    const rW=cssW*dpr, rH=cssH*dpr;
    if(cvs.width!==rW||cvs.height!==rH){cvs.width=rW;cvs.height=rH;}
    cvs.style.width=cssW+'px'; cvs.style.height=cssH+'px';
    ctx.setTransform(rW/DESIGN_W,0,0,rH/DESIGN_H,0,0);
  }
  addEventListener('resize', resize); addEventListener('orientationchange', resize); resize();

  // ---------- Menu and audio ----------
  const menu=document.getElementById('menu');
  const playBtn=document.getElementById('playBtn');
  const musicBtn=document.getElementById('musicBtn');
  const creditsBtn=document.getElementById('creditsBtn');
  const toastEl=document.getElementById('toast');
  const S = {
    menu:document.getElementById('aud_menu'),
    crane:document.getElementById('aud_crane'),
    snake:document.getElementById('aud_snake'),
    tiger:document.getElementById('aud_tiger'),
    temple:document.getElementById('aud_temple'),
    vict:document.getElementById('aud_vict'),
    over:document.getElementById('aud_over'),
    cred:document.getElementById('aud_cred')
  };
  let musicOn=true, currentTrack=null;
  function playTrack(tr){ if(!musicOn) return;
    if(currentTrack&&currentTrack!==tr){ currentTrack.pause(); currentTrack.currentTime=0; }
    currentTrack=tr; currentTrack.volume=0.9; currentTrack.play().catch(()=>{});
  }
  musicBtn.onclick=()=>{ musicOn=!musicOn; musicBtn.textContent='Music: '+(musicOn?'On':'Off');
    if(!musicOn){ for(const a of Object.values(S)) a.pause(); }
    else { if(menu.style.display!=='none') playTrack(S.menu); else selectStageMusic(); }
  };
  creditsBtn.onclick=()=>alert('Credits\nGame concept by you.\nMusic by you.\nCode & art integration by Game Builder AI.');

  // Load optional title art if present
  const menuArt=document.getElementById('menuArt');
  (function(){
    const img=new Image();
    img.onload=()=>{ menuArt.src='menu-title.png'; };
    img.onerror=()=>{ /* keep gradient */ };
    img.src='menu-title.png';
  })();

  // Start menu music after first gesture (mobile rule)
  function userKick(){ if(menu.style.display!=='none' && musicOn){ playTrack(S.menu); } }
  addEventListener('pointerdown', userKick, {once:true});
  addEventListener('keydown', userKick, {once:true});

  // ---------- Input ----------
  const keys=new Set();
  const mapKey=e=>{const k=e.code; if(e.type==='keydown') keys.add(k); else keys.delete(k);};
  addEventListener('keydown', mapKey); addEventListener('keyup', mapKey);
  document.querySelectorAll('.btn').forEach(b=>{
    const k=b.dataset.k; const down=()=>{keys.add(k); b.style.transform='scale(0.96)';};
    const up=()=>{keys.delete(k); b.style.transform='scale(1)';};
    b.addEventListener('pointerdown', down); addEventListener('pointerup', up);
    addEventListener('pointercancel', up); addEventListener('pointerleave', up);
  });

  // ---------- HUD helpers ----------
  const hud = {
    stageName: document.getElementById('stageName'),
    lessons: document.getElementById('lessons'),
    bal: document.getElementById('balanceBar'),
    foc: document.getElementById('focusBar'),
    pow: document.getElementById('powerBar'),
  };
  function stageName(i){return ['Crane: Balance','Snake: Focus','Tiger: Power','Temple: Master'][i]}
  function toast(msg, t=1800){ toastEl.textContent=msg; toastEl.style.opacity=1; setTimeout(()=>toastEl.style.opacity=0, t); }

  // ---------- Sprites (3x4 grid) ----------
  const sprite = new Image();
  sprite.src='raiden-sprites.png'; // optional
  let sprReady=false;
  sprite.onload=()=>{ sprReady=true; sprCols=3; sprRows=4; sprW=sprite.width/sprCols; sprH=sprite.height/sprRows; };
  let sprCols=3, sprRows=4, sprW=48, sprH=64; // defaults

  const Anim = {
    idle:[0,1,2,3],
    punch:[4,5,6,7],
    walk:[8,9,10,11],
    jump:[6]
  };

  // ---------- Game objects ----------
  const groundY=DESIGN_H-180; // portrait ground
  const state={stage:0, lessons:0, balance:50, focus:0, power:0};

  class Player{
    constructor(){
      this.x=140; this.y=groundY-60; this.w=32; this.h=48;
      this.vx=0; this.vy=0; this.onGround=false; this.facing=1;
      this.anim='idle'; this.ai=0; this.at=0; this.frameTime=0;
      this.drawScale=1.3;      // scale sprite up
      this.offsetY=6;          // lift sprite so feet meet ground
      this.anchorX=0.5;        // draw from bottom-center
      this.anchorY=1.0;
    }
    changeAnim(a){ if(this.anim!==a){ this.anim=a; this.ai=0; this.frameTime=0; } }
    step(dt){
      const sp=160;
      const left = keys.has('ArrowLeft')||keys.has('KeyA');
      const right= keys.has('ArrowRight')||keys.has('KeyD');
      if(left&&!right){this.vx=-sp; this.facing=-1; this.changeAnim('walk');}
      else if(right&&!left){this.vx=sp; this.facing=1; this.changeAnim('walk');}
      else {this.vx=0; if(this.onGround) this.changeAnim('idle');}
      if((keys.has('ArrowUp')||keys.has('KeyW')) && this.onGround){ this.vy=-360; this.onGround=false; this.changeAnim('jump'); }
      if(keys.has('KeyJ')) this.changeAnim('punch');

      // physics
      this.vy += 900*dt;
      this.x += this.vx*dt; this.y += this.vy*dt;

      // ground
      const feet = this.y+this.h;
      if(feet >= groundY){ this.y = groundY - this.h; this.vy=0; this.onGround=true; if(this.vx===0 && this.anim!=='punch') this.changeAnim('idle'); }

      // anim advance
      const rate = this.anim==='walk'? 0.10 : this.anim==='punch'? 0.09 : this.anim==='jump'? 0.12 : 0.12;
      this.frameTime += dt;
      if(this.frameTime>rate){ this.frameTime=0; this.ai=(this.ai+1) % Anim[this.anim].length; }
    }
    draw(){
      // draw sprite or fallback
      if(sprReady){
        const idx = Anim[this.anim][this.ai];
        const sx = (idx % sprCols) * sprW;
        const sy = Math.floor(idx / sprCols) * sprH;
        const dw = sprW*this.drawScale, dh = sprH*this.drawScale;
        const dx = this.x + this.w*0.5 - dw*this.anchorX;
        const dy = this.y + this.h - dh*this.anchorY - this.offsetY;
        ctx.save();
        if(this.facing<0){ ctx.translate(dx+dw, dy); ctx.scale(-1,1); ctx.drawImage(sprite, sx, sy, sprW, sprH, 0, 0, dw, dh); }
        else { ctx.drawImage(sprite, sx, sy, sprW, sprH, dx, dy, dw, dh); }
        ctx.restore();
      }else{
        ctx.fillStyle='#f5b11b'; ctx.fillRect(this.x, this.y, this.w, this.h);
      }
    }
  }
  const player=new Player();

  // simple obstacles per stage
  const obstacles={
    0:[{x:80,w:280,type:'log'}],
    1:[{x:60,w:120,type:'spike'},{x:260,w:140,type:'spike'}],
    2:[{x:120,w:40,type:'boulder'},{x:280,w:120,type:'gate'}],
    3:[]
  };
  const npcs=[
    {stage:0,name:'Crane',x:410,y:groundY-44,color:'#a3e635',line:'"Balance brings structure."'},
    {stage:1,name:'Snake',x:420,y:groundY-44,color:'#22d3ee',line:'"Focus. Flow. Be still and sharp."'},
    {stage:2,name:'Tiger',x:420,y:groundY-50,color:'#f59e0b',line:'"Power lives inside you."'},
    {stage:3,name:'Master',x:360,y:groundY-50,color:'#f472b6',line:'"Wing Chun is here — in your heart."'}
  ];

  function drawBackground(stage){
    const g=ctx.createLinearGradient(0,0,0,DESIGN_H);
    if(stage===0){g.addColorStop(0,'#0a1729');g.addColorStop(1,'#0f2138');}
    if(stage===1){g.addColorStop(0,'#0a1c17');g.addColorStop(1,'#14332b');}
    if(stage===2){g.addColorStop(0,'#1a1111');g.addColorStop(1,'#2b1a1a');}
    if(stage===3){g.addColorStop(0,'#0f1b2b');g.addColorStop(1,'#18324f');}
    ctx.fillStyle=g; ctx.fillRect(0,0,DESIGN_W,DESIGN_H);
    // ground
    ctx.fillStyle='#243041'; ctx.fillRect(0, groundY, DESIGN_W, DESIGN_H-groundY);
  }
  function drawNPC(n){ if(!n) return; ctx.save(); ctx.translate(n.x, n.y); ctx.fillStyle=n.color; ctx.fillRect(-10,-20,20,20); ctx.fillStyle='#222'; ctx.fillRect(-12,0,24,4); ctx.restore(); }
  function aabb(a,b){ return !(a.x+a.w<b.x||a.x>b.x+b.w||a.y+a.h<b.y-b.h||a.y>b.y); }

  function nextStage(){ state.stage=Math.min(3,state.stage+1); hud.stageName.textContent=stageName(state.stage); player.x=120; player.y=groundY-60; player.vx=player.vy=0; selectStageMusic(); toast(state.stage<3?'New lesson ahead.':'You found the Wing Chun Temple.'); }
  function selectStageMusic(){ if(!musicOn) return;
    if(state.stage===0) playTrack(S.crane);
    if(state.stage===1) playTrack(S.snake);
    if(state.stage===2) playTrack(S.tiger);
    if(state.stage===3) playTrack(S.temple);
  }

  // --- Start at menu
  function startGame(){
    menu.style.display='none';
    if(musicOn){ if(currentTrack) currentTrack.pause(); selectStageMusic(); }
  }
  playBtn.onclick=()=>startGame();

  // --- Main loop
  let last=performance.now();
  function loop(now){
    const dt=Math.min(0.033,(now-last)/1000); last=now;

    // Stage logic
    if(state.stage===0){
      const log=obstacles[0][0];
      const onLog=player.x+player.w>log.x&&player.x<log.x+log.w&&player.y+player.h>=groundY;
      if(onLog){
        state.balance+=Math.sin(now*0.004)*0.4;
        if(keys.has('ArrowLeft')||keys.has('KeyA')) state.balance-=0.6;
        if(keys.has('ArrowRight')||keys.has('KeyD')) state.balance+=0.6;
        state.balance=Math.max(0,Math.min(100,state.balance));
      }
    }
    if(state.stage===1){ state.focus=Math.max(0,Math.min(100,state.focus+(keys.has('Space')?45*dt:-25*dt))); }
    if(state.stage===2){ state.power = Math.max(0,Math.min(100, state.power + (keys.has('KeyK')?60:-40)*dt )); }

    player.step(dt);

    // interactions
    const obs=obstacles[state.stage];
    for(const o of obs){
      if(state.stage===1&&o.type==='spike'){
        const flashing=Math.floor(now/600)%2===0;
        if(flashing&&aabb({x:player.x,y:player.y,w:player.w,h:player.h},{x:o.x,y:groundY,w:o.w,h:28})){
          if(state.focus<70){ player.x=120; toast('Be still and sharp. (Focus)'); }
        }
      }
      if(state.stage===2){
        if(o.type==='boulder'&&Math.abs(player.x-o.x)<36&&state.power>65){ o.x+=120; toast('Inner power moves mountains!'); }
        if(o.type==='gate'&&Math.abs(player.x-(o.x+o.w/2))<40&&state.power>80){ o.w=Math.max(0,o.w-160); toast('Gate yields to calm strength.'); }
      }
    }

    const npc=npcs.find(n=>n.stage===state.stage);
    if(npc&&Math.abs(player.x-npc.x)<34){
      if(state.stage===0&&state.balance>=45&&state.balance<=55){state.lessons++;toast(npc.line);nextStage();}
      else if(state.stage===1&&state.focus>=80){state.lessons++;toast(npc.line);nextStage();}
      else if(state.stage===2&&state.power>=80){state.lessons++;toast(npc.line);nextStage();}
      else if(state.stage===3){toast(npc.line+'\nCalm. Proud. Strong.');}
    }

    // Draw
    drawBackground(state.stage);
    // draw a simple log for stage 0
    if(state.stage===0){ const log=obstacles[0][0]; ctx.fillStyle='#7a4e24'; ctx.fillRect(log.x, groundY-12, log.w, 12); }
    drawNPC(npc);
    player.draw();

    // HUD update
    hud.lessons.textContent=`${state.lessons}/3`;
    document.getElementById('balanceBar').style.width=`${state.balance|0}%`;
    document.getElementById('focusBar').style.width=`${state.focus|0}%`;
    document.getElementById('powerBar').style.width=`${state.power|0}%`;

    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  // Start with menu visible and menu music ready
  (function init(){
    hud.stageName.textContent=stageName(state.stage);
    // attempt to preload and softly start menu music on gesture handled earlier
  })();
})();
</script>
</body>
</html>
