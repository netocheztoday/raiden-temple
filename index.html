<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Raiden and the Wing Chun Temple</title>
<style>
  :root{ --frame-max: 980px; --pad: 12px; }
  html,body{ margin:0; background:#000; color:#fff; font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
  #frame{ max-width:var(--frame-max); margin:0 auto; padding:0 var(--pad);}
  #menu{ display:flex; flex-direction:column; align-items:center; gap:14px; padding:18px 0;}
  #menu img{ width:100%; height:auto; display:block; border-radius:6px;}
  .btn{ background:#111; border:2px solid #fff; color:#fff; border-radius:8px; padding:12px 22px; font-size:18px;}
  .btn:active{ transform:translateY(1px);}

  /* Game */
  #wrap{ position:relative;}
  #cvs{ display:none; width:100%; height:auto; background:#0b1622; image-rendering:pixelated; border-radius:12px;}
  #hud{ position:absolute; left:12px; top:12px; background:rgba(0,0,0,.55); padding:6px 10px; border-radius:8px;
        font-family:monospace; font-size:14px; display:none;}
  #tag{ position:absolute; left:12px; top:12px; transform:translateY(28px); background:#0b0e12; color:#cfe1ff;
        padding:4px 8px; border-radius:10px; font:12px/1.2 monospace; opacity:.85; display:none;}
  #hearts{ position:absolute; right:12px; top:12px; font-size:18px; display:none; text-shadow:0 2px 0 #0008;}
  /* Overlay */
  #overlay{ position:absolute; inset:0; display:none; align-items:center; justify-content:center; }
  #overlay .box{ background:#0b0e12dd; border:2px solid #fff; border-radius:10px; padding:24px; text-align:center; }
  #overlay .box h2{ margin:0 0 14px; }
  #overlay .box .btn{ margin:6px 8px 0; }

  /* Touch controls */
  #controls{ display:none; gap:10px; justify-content:space-between; margin:10px 0;}
  .pad{ flex:1; min-width:90px; height:64px; font-size:22px; border:2px solid #303a46;
        background:#141c26; color:#fff; border-radius:12px;}
  .pad:active{ filter:brightness(1.2);}
</style>
</head>
<body>
  <div id="frame">
    <!-- MENU -->
    <div id="menu">
      <img src="menu-title.png" alt="Raiden and the Wing Chun Temple">
      <button class="btn" onclick="startGame()">Play</button>
      <button class="btn" id="musicBtn" onclick="toggleMusic()">Music: On</button>
      <button class="btn" onclick="alert('Credits\nMusic & Art: You\nCode helper: ChatGPT')">Credits</button>
    </div>

    <!-- GAME -->
    <div id="wrap">
      <canvas id="cvs" width="800" height="450"></canvas>
      <div id="hud">Stage: <span id="stageName">â€”</span></div>
      <div id="hearts"></div>
      <div id="tag"></div>

      <div id="overlay">
        <div class="box">
          <h2 id="ovTitle">Game Over</h2>
          <p id="ovMsg">You fell into the ditch!</p>
          <div>
            <button class="btn" onclick="retryLevel()">Retry</button>
            <button class="btn" onclick="backToMenu()">Menu</button>
          </div>
        </div>
      </div>
    </div>

    <div id="controls">
      <button class="pad" ontouchstart="keys.left=1"  ontouchend="keys.left=0">â—€</button>
      <button class="pad" ontouchstart="keys.right=1" ontouchend="keys.right=0">â–¶</button>
      <button class="pad" ontouchstart="tapPunch(1)"  ontouchend="tapPunch(0)">J</button>
      <button class="pad" ontouchstart="tapJump(1)"   ontouchend="tapJump(0)">â†‘</button>
    </div>
  </div>

<script>
/* ======= AUDIO ======= */
let musicOn = true, currentMusic = "menu";
const tracks = {};
["menu","crane","snake","tiger","temple","victory","gameover","credits"].forEach(n=>{
  const a = new Audio(n + ".mp3");
  a.loop = (n!=="victory" && n!=="gameover");
  tracks[n] = a;
});
function stopAll(){ for(const a of Object.values(tracks)){ a.pause(); a.currentTime=0; } }
function playMusic(name){ if(!musicOn) return; stopAll(); currentMusic=name; tracks[name]?.play(); }
function toggleMusic(){
  musicOn = !musicOn;
  document.getElementById("musicBtn").textContent = "Music: " + (musicOn?"On":"Off");
  if(musicOn) playMusic(currentMusic); else stopAll();
}

/* ======= CANVAS ======= */
const cvs = document.getElementById("cvs");
const ctx = cvs.getContext("2d",{alpha:true});
ctx.imageSmoothingEnabled = false;

/* ======= SPRITE ======= */
const tag = document.getElementById("tag");
let spriteReady=false, FW=0, FH=0, COLS=3, ROWS=3;
const sprite = new Image();
sprite.src = "raiden-sprites.png?v="+Date.now();
sprite.onload = ()=>{ FW=Math.floor(sprite.naturalWidth/COLS); FH=Math.floor(sprite.naturalHeight/ROWS);
  spriteReady=true; tag.style.display="block"; tag.textContent="sprite: ok"; };
sprite.onerror = ()=>{ tag.style.display="block"; tag.textContent="sprite: missing"; };

/* ======= BACKGROUNDS ======= */
const roomBG  = new Image(); roomBG.src  = 'bg-room.png';
const fieldBG = new Image(); fieldBG.src = 'bg-field.png';

/* ======= LEVELS ======= */
const LEVELS = [
  // 0
  { id:'room',  name:"Raidenâ€™s Room", music:'menu', bg:roomBG,  ground:'#2b3542',
    doors:[ {x:700, w:54, h:120, target:'field', label:'â†’'} ],
    pit:null },

  // 1 (with ditch)
  { id:'field', name:"Outside: Choose a Path", music:'crane', bg:fieldBG, ground:'#8a5a32',
    doors:[
      {x:40,  w:50, h:118, target:'room',  label:'âŸµ'},
      {x:715, w:50, h:118, target:'crane', label:'âŸ¶'}
    ],
    pit:{ x: (800-180)/2, w:180 }   // center gap; tune width here
  },

  // 2
  { id:'crane', name:"Crane: Balance", music:'crane',
    bg:null, bgTop:"#0e2230", bgMid:"#132a3a", bgBot:"#0b1b27", ground:"#8a5a32",
    doors:[], pit:null },
];

function levelById(id){ return LEVELS.findIndex(L=>L.id===id); }

/* ======= PLAYER / PHYS ======= */
const hud = document.getElementById("hud");
const heartsEl = document.getElementById("hearts");
const overlay = document.getElementById("overlay");
const stageName = document.getElementById("stageName");

const GROUND_Y = cvs.height - 90;
let DRAW_W=54, DRAW_H=81;

const player = { x: (cvs.width-DRAW_W)/2 - 140, y: GROUND_Y - DRAW_H, vx:0, vy:0, facing:1,
                 state:"idle", tick:0 };
const anims = {
  idle : { frames:[0,1,2], speed:12 },
  walk : { frames:[3,4,5], speed: 8 },
  punch: { frames:[6,7],   speed: 6, hold:8 },
  jump : { frames:[8],     speed:12 }
};
const keys = { left:0, right:0, jump:0, punch:0 };
function tapJump(v){ keys.jump=v; }
function tapPunch(v){ keys.punch=v; }

/* lives */
let lives = 3;
function drawHearts(){
  heartsEl.style.display = "block";
  heartsEl.innerHTML = "ðŸ’›".repeat(lives);
}

/* ======= GAME FLOW ======= */
let inGame=false, levelIndex=0;
let jumps=0, prevJump=0;

function spawnLeft(){ player.x=120; player.y=GROUND_Y-DRAW_H; player.vx=0; player.vy=0; jumps=0; prevJump=0; }
function startGame(){
  document.getElementById("menu").style.display="none";
  cvs.style.display="block";
  document.getElementById("controls").style.display="flex";
  hud.style.display="block";
  heartsEl.style.display="block";
  lives = 3; drawHearts();
  setLevel(levelById('room'));
  inGame = true;
  requestAnimationFrame(loop);
}
function setLevel(i){
  levelIndex = i;
  const L = LEVELS[levelIndex];
  stageName.textContent = L.name;
  playMusic(L.music || 'menu');
  spawnLeft();
  overlay.style.display = "none";
}
function retryLevel(){
  lives = 3; drawHearts();
  setLevel(levelIndex);
}
function backToMenu(){
  stopAll();
  location.reload();
}

/* ======= LOOP ======= */
function loop(){ requestAnimationFrame(loop); if(!inGame) return; update(); render(); }

function update(){
  const L = LEVELS[levelIndex];

  // horizontal
  player.vx = 0;
  if(keys.left){  player.vx = -3; player.facing = -1; }
  if(keys.right){ player.vx =  3; player.facing =  1; }

  // double-jump edge detect
  const justPressed = keys.jump && !prevJump; prevJump = keys.jump?1:0;

  // ground check depends on pit presence
  const pit = L.pit;
  let onGround = (player.y >= GROUND_Y - DRAW_H);

  // if there's a pit, disable ground where the gap is
  if(pit){
    const overLeft  = (player.x + DRAW_W) <= pit.x;
    const overRight = player.x >= pit.x + pit.w;
    const feetAtGround = (player.y >= GROUND_Y - DRAW_H - 0.01);
    if(feetAtGround && !(overLeft || overRight)) onGround = false;
  }

  if(onGround) jumps=0;
  if(justPressed){
    if(jumps===0){ player.vy = -10; player.state="jump"; jumps=1; }
    else if(jumps===1){ player.vy = -9; player.state="jump"; jumps=2; }
  }

  // physics
  player.vy += 0.55;
  player.x  += player.vx;
  player.y  += player.vy;

  // floor clamp (only if not inside pit)
  if(player.y >= GROUND_Y - DRAW_H){
    let canLand = true;
    if(pit){
      const overLeft  = (player.x + DRAW_W) <= pit.x;
      const overRight = player.x >= pit.x + pit.w;
      if(!(overLeft || overRight)) canLand = false;
    }
    if(canLand){
      player.y = GROUND_Y - DRAW_H;
      if(player.state === "jump") player.state="idle";
      player.vy = 0;
    }
  }

  // fell below screen?
  if(player.y > cvs.height + 40){
    lives--;
    drawHearts();
    if(lives > 0){ spawnLeft(); }
    else{
      playMusic('gameover');
      overlay.style.display = "flex";
    }
  }

  // state
  if(keys.punch)      player.state = "punch";
  else if(player.vx)  player.state = "walk";
  else if(player.state!=="jump") player.state = "idle";

  player.tick++;

  // doors overlap
  if(L.doors){
    const px=player.x, py=player.y, pw=DRAW_W, ph=DRAW_H;
    for(const d of L.doors){
      const dx=d.x, dy=GROUND_Y-d.h, dw=d.w, dh=d.h;
      if(px < dx+dw && px+pw > dx && py < dy+dh && py+ph > dy){
        setLevel( levelById(d.target) );
        break;
      }
    }
  }
}

function render(){
  const L = LEVELS[levelIndex];

  // background image cover
  if(L.bg instanceof Image && L.bg.complete){
    const iw=L.bg.naturalWidth, ih=L.bg.naturalHeight;
    const s=Math.max(cvs.width/iw, cvs.height/ih);
    const dw=Math.floor(iw*s), dh=Math.floor(ih*s);
    const dx=Math.floor((cvs.width-dw)/2), dy=Math.floor((cvs.height-dh)/2);
    ctx.imageSmoothingEnabled=false;
    ctx.drawImage(L.bg, 0,0,iw,ih, dx,dy, dw,dh);
  }else{
    ctx.fillStyle=L.bgTop||"#0e2230"; ctx.fillRect(0,0,cvs.width,cvs.height*0.50);
    ctx.fillStyle=L.bgMid||"#132a3a"; ctx.fillRect(0,cvs.height*0.50,cvs.width,cvs.height*0.25);
    ctx.fillStyle=L.bgBot||"#0b1b27"; ctx.fillRect(0,cvs.height*0.75,cvs.width,cvs.height*0.25);
  }

  // ground (with optional pit)
  const pit=L.pit;
  ctx.fillStyle = L.ground || "#8a5a32";
  if(pit){
    // left cliff
    ctx.fillRect(30, GROUND_Y, pit.x - 30, 28);
    // right cliff
    const rightW = (cvs.width - 30) - (pit.x + pit.w);
    ctx.fillRect(pit.x + pit.w, GROUND_Y, rightW, 28);
    // pit dark
    ctx.fillStyle = "#1a1010";
    ctx.fillRect(pit.x, GROUND_Y, pit.w, 34);
  }else{
    ctx.fillRect(30, GROUND_Y, cvs.width-60, 28);
  }

  // doors
  if(L.doors){
    for(const d of L.doors){
      ctx.fillStyle="#996c52"; ctx.fillRect(d.x-2, GROUND_Y-d.h-2, d.w+4, d.h+4);
      ctx.fillStyle="#89b9ac"; ctx.fillRect(d.x,   GROUND_Y-d.h,   d.w,   d.h);
      if(d.label){ ctx.font="14px monospace"; ctx.fillStyle="#fff"; ctx.textAlign="center";
        ctx.fillText(d.label, d.x+d.w/2, GROUND_Y-d.h-6); }
    }
  }

  // player
  if(spriteReady){
    const a=anims[player.state];
    const f=a.frames[Math.floor(player.tick/a.speed)%a.frames.length];
    drawFrame(f, Math.round(player.x), Math.round(player.y), player.facing<0);
  }
}

function drawFrame(f, dx, dy, flip){
  const PAD=2, col=f%COLS, row=(f/COLS)|0;
  const sx=col*FW+PAD, sy=row*FH+PAD, sw=FW-PAD*2, sh=FH-PAD*2;
  ctx.save();
  if(flip){ ctx.translate(dx+DRAW_W,dy); ctx.scale(-1,1); ctx.drawImage(sprite,sx,sy,sw,sh,0,0,DRAW_W,DRAW_H); }
  else    { ctx.drawImage(sprite,sx,sy,sw,sh,dx,dy,DRAW_W,DRAW_H); }
  ctx.restore();
}

/* ======= INPUT ======= */
addEventListener("keydown", e=>{
  if(e.key==="ArrowLeft"||e.key==="a") keys.left=1;
  if(e.key==="ArrowRight"||e.key==="d") keys.right=1;
  if(e.key==="ArrowUp"||e.key==="w"||e.key===" ") keys.jump=1;
  if(e.key==="j"||e.key==="J") keys.punch=1;
});
addEventListener("keyup", e=>{
  if(e.key==="ArrowLeft"||e.key==="a") keys.left=0;
  if(e.key==="ArrowRight"||e.key==="d") keys.right=0;
  if(e.key==="ArrowUp"||e.key==="w"||e.key===" ") keys.jump=0;
  if(e.key==="j"||e.key==="J") keys.punch=0;
});
</script>
</body>
</html>
