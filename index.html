<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>Raiden and the Wing Chun Temple</title>
<style>
  html,body { margin:0; height:100%; background:#0c0f14; color:#fff; font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial; }
  /* Stage container scales uniformly */
  #stage{
    position:fixed;
    left:50%;
    top:50%;
    transform:translate(-50%,-50%) scale(var(--s,1));
    transform-origin: top left;
    width:960px;
    height:540px;
    image-rendering: pixelated;
    background:#0c0f14;
  }
  #canvas { display:block; background:#0c0f14; }
  #ui{ position:absolute; inset:0; pointer-events:none; }
  .hud{position:absolute;left:12px;top:10px;background:rgba(0,0,0,.35);padding:8px 10px;border-radius:8px;font-size:14px}
  .bar{height:8px;background:#222;border-radius:6px;overflow:hidden;margin:6px 0}
  .bar>i{display:block;height:100%;background:linear-gradient(90deg,#aaf,#7cf);width:0%}
  .row{display:flex;gap:8px;align-items:center}
  .token{display:inline-block;background:#222;border:1px solid #444;border-radius:6px;padding:2px 6px;margin-right:6px}
  .toast{position:absolute;left:50%;transform:translateX(-50%);bottom:14%;background:rgba(0,0,0,.55);padding:8px 12px;border-radius:8px;font-weight:600}
  /* Mobile controls */
  #controls{position:absolute;left:12px;right:12px;bottom:12px;display:flex;justify-content:space-between;gap:8px}
  .btn{pointer-events:auto;touch-action:manipulation;background:#1b2533;border:1px solid #2f3d55;border-radius:12px;
       color:#fff;font-weight:700;min-width:54px;min-height:54px;display:flex;align-items:center;justify-content:center;user-select:none}
  .cluster{display:flex;gap:8px}
  @media (pointer:fine){#controls{display:none}}
  /* Menu */
  #menu{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6)}
  .panel{pointer-events:auto;background:#111826;border:1px solid #334155;border-radius:14px;padding:18px 20px;max-width:560px}
  .panel h1{margin:0 0 6px;font-size:24px}
  .panel p{margin:6px 0 10px;opacity:.9}
  .panel .row{justify-content:flex-start}
  .panel button{pointer-events:auto;margin-right:10px;padding:10px 14px;border-radius:10px;border:1px solid #2f3d55;background:#1b2533;color:#fff;font-weight:700}
</style>
</head>
<body>
<div id="stage">
  <!-- Menu -->
  <div id="menu">
    <div class="panel">
      <h1>Raiden and the Wing Chun Temple</h1>
      <p>Press Play to begin your training.</p>
      <div class="row">
        <button id="playBtn">▶ Play</button>
        <button id="musicBtn">Music: On</button>
        <button id="creditsBtn">Credits</button>
      </div>
      <p style="font-size:12px;opacity:.7;margin-top:10px">Controls: Arrow keys/WASD move & jump · J punch · K interact · Space focus · Esc pause</p>
    </div>
  </div>

  <!-- Game canvas -->
  <canvas id="canvas" width="960" height="540"></canvas>

  <!-- HUD -->
  <div id="ui">
    <div class="hud" id="hud">
      <div><span class="token">Stage: <b id="stageName">Crane: Balance</b></span>
           <span class="token">Lessons: <b id="lessons">0/3</b></span></div>
      <div class="row">Balance
        <div class="bar" style="width:160px"><i id="balanceBar"></i></div>
      </div>
      <div class="row">Focus
        <div class="bar" style="width:160px"><i id="focusBar"></i></div>
      </div>
      <div class="row">Power
        <div class="bar" style="width:160px"><i id="powerBar"></i></div>
      </div>
    </div>
    <div class="toast" id="toast" style="opacity:0">Welcome! Reach each animal guide.</div>
  </div>

  <!-- Mobile controls -->
  <div id="controls">
    <div class="cluster">
      <div class="btn" data-k="ArrowLeft">◀</div>
      <div class="btn" data-k="ArrowRight">▶</div>
      <div class="btn" data-k="Space">⏺ Focus</div>
    </div>
    <div class="cluster">
      <div class="btn" data-k="KeyJ">J</div>
      <div class="btn" data-k="KeyK">K</div>
      <div class="btn" data-k="ArrowUp">⤒</div>
    </div>
  </div>
</div>

<script>
// ---- SCALE GAME TO FIT SCREEN (no stretch) ----
(function(){
  function fit(){
    const W = 960, H = 540;
    const s = Math.min(window.innerWidth / W, window.innerHeight / H);
    document.documentElement.style.setProperty('--s', s.toString());
  }
  window.addEventListener('resize', fit);
  window.addEventListener('orientationchange', fit);
  fit();
})();

// ---- Music hooks ----
const tracks = {
  menu: "menu.mp3",
  crane: "crane.mp3",
  snake: "snake.mp3",
  tiger: "tiger.mp3",
  temple: "temple.mp3",
  victory: "victory.mp3",
  gameover: "gameover.mp3",
  credits: "credits.mp3"
};
let musicOn = true, currentAudio = null;
function playTrack(key, loop=true){
  if(!musicOn) return;
  if(currentAudio){ currentAudio.pause(); currentAudio=null; }
  const src = tracks[key];
  if(!src) return;
  const audio = new Audio(src);
  audio.loop = loop;
  audio.volume = 0.7;
  audio.play();
  currentAudio = audio;
}
function stopTrack(){ if(currentAudio){ currentAudio.pause(); currentAudio=null; }}

// ---- Game basics ----
(() => {
  const W=960,H=540;
  const cvs=document.getElementById('canvas'),ctx=cvs.getContext('2d');
  const hud={stageName:document.getElementById('stageName'),lessons:document.getElementById('lessons'),
             bal:document.getElementById('balanceBar'),foc:document.getElementById('focusBar'),pow:document.getElementById('powerBar'),
             toast:document.getElementById('toast')};
  const menu=document.getElementById('menu');
  const playBtn=document.getElementById('playBtn');
  const musicBtn=document.getElementById('musicBtn');
  const creditsBtn=document.getElementById('creditsBtn');

  const keys=new Set();
  const mapKey=e=>{const k=e.code; if(e.type==='keydown') keys.add(k); else keys.delete(k);};
  addEventListener('keydown', mapKey); addEventListener('keyup', mapKey);
  document.querySelectorAll('.btn').forEach(b=>{
    const k=b.dataset.k; const down=()=>{keys.add(k); b.style.transform='scale(0.96)';};
    const up=()=>{keys.delete(k); b.style.transform='scale(1)';};
    b.addEventListener('pointerdown', down);
    addEventListener('pointerup', up);
    addEventListener('pointercancel', up);
    addEventListener('pointerleave', up);
  });

  function toast(msg,dur=2200){hud.toast.textContent=msg; hud.toast.style.opacity=1; setTimeout(()=>hud.toast.style.opacity=0,dur);}

  const state={stage:0,lessons:0,balance:50,focus:0,power:0};
  const groundY=H-80;

  // Sprite sheet
  const raidenImg = new Image();
  raidenImg.src = "raiden-sprites.png"; // upload this file to repo root
  const frameW = 128, frameH = 128; // adjust if your sheet differs
  let animTime=0, animFrame=0;

  class Player{
    constructor(){this.x=80;this.y=groundY-42;this.w=32;this.h=42;this.vx=0;this.vy=0;this.onGround=false;this.facing=1;this.state="idle";}
    step(dt){
      const sp=170;
      if(keys.has('ArrowLeft')||keys.has('KeyA')){this.vx=-sp;this.facing=-1;this.state="walk";}
      else if(keys.has('ArrowRight')||keys.has('KeyD')){this.vx=sp;this.facing=1;this.state="walk";}
      else {this.vx=0; if(this.onGround) this.state="idle";}
      if((keys.has('ArrowUp')||keys.has('KeyW'))&&this.onGround){this.vy=-300;this.onGround=false;this.state="jump";}
      this.vy+=900*dt; this.x+=this.vx*dt; this.y+=this.vy*dt;
      if(this.y+this.h>=groundY){this.y=groundY-this.h; this.vy=0; this.onGround=true;}
      if(keys.has('KeyJ')){this.state="punch";}
    }
    draw(dt){
      animTime+=dt;
      if(animTime>0.15){animTime=0; animFrame=(animFrame+1)%4;}
      let row=0;
      if(this.state==="idle") row=0;
      if(this.state==="walk") row=1;
      if(this.state==="punch") row=2;
      if(this.state==="jump") row=3;
      ctx.save();
      ctx.translate(this.x+this.w/2,this.y+this.h/2);
      ctx.scale(this.facing,1);
      ctx.drawImage(raidenImg, animFrame*frameW,row*frameH,frameW,frameH,
                    -this.w/2-16,-this.h/2-16,64,64);
      ctx.restore();
    }
  }
  const player=new Player();

  const npcs=[
    {stage:0,name:'Crane',x:720,y:groundY-40,color:'#a3e635',line:'"Balance brings structure."'},
    {stage:1,name:'Snake',x:760,y:groundY-40,color:'#22d3ee',line:'"Focus. Flow. Be still and sharp."'},
    {stage:2,name:'Tiger',x:760,y:groundY-48,color:'#f59e0b',line:'"Power lives inside you."'},
    {stage:3,name:'Master',x:600,y:groundY-46,color:'#f472b6',line:'"Wing Chun is here — in your heart."'}
  ];
  const obstacles={0:[{x:300,w:300,type:'log'}],1:[{x:280,w:120,type:'spike'},{x:480,w:140,type:'spike'},{x:620,w:60,type:'spike'}],2:[{x:320,w:40,type:'boulder'},{x:480,w:40,type:'boulder'},{x:640,w:120,type:'gate'}],3:[]};

  function drawBackground(stage){
    const g=ctx.createLinearGradient(0,0,0,H);
    if(stage===0){g.addColorStop(0,'#0a1729');g.addColorStop(1,'#0f2138');}
    if(stage===1){g.addColorStop(0,'#0a1c17');g.addColorStop(1,'#14332b');}
    if(stage===2){g.addColorStop(0,'#1a1111');g.addColorStop(1,'#2b1a1a');}
    if(stage===3){g.addColorStop(0,'#0f1b2b');g.addColorStop(1,'#18324f');}
    ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
    ctx.fillStyle='#1e293b'; ctx.fillRect(0,groundY,W,H-groundY);
  }
  function drawNPC(n){ctx.save();ctx.translate(n.x,n.y);ctx.fillStyle=n.color;ctx.fillRect(-10,-20,20,20);ctx.fillStyle='#222';ctx.fillRect(-12,0,24,4);ctx.restore();}
  function aabb(a,b){return !(a.x+a.w<b.x||a.x>b.x+b.w||a.y+a.h<b.y-b.h||a.y>b.y);}

  function stageName(i){return ['Crane: Balance','Snake: Focus','Tiger: Power','Temple: Master'][i]}
  function nextStage(){
    state.stage=Math.min(3,state.stage+1);
    hud.stageName.textContent=stageName(state.stage);
    player.x=80;player.y=groundY-42;player.vx=player.vy=0;
    stopTrack();
    if(state.stage===0) playTrack("crane");
    if(state.stage===1) playTrack("snake");
    if(state.stage===2) playTrack("tiger");
    if(state.stage===3) playTrack("temple");
    toast(state.stage<3?'New lesson ahead.':'You found the Wing Chun Temple.');
  }

  // Menu
  playBtn.onclick=()=>{menu.style.display='none'; playTrack("crane");};
  musicBtn.onclick=()=>{musicOn=!musicOn; musicBtn.textContent='Music: '+(musicOn?'On':'Off'); if(!musicOn) stopTrack(); else playTrack("crane");};
  creditsBtn.onclick=()=>{stopTrack(); playTrack("credits"); alert('Credits: Music by You, Game built with love!');};

  function startMenu(){ playTrack("menu"); }
  window.addEventListener('pointerdown', startMenu, {once:true});
  window.addEventListener('keydown', startMenu, {once:true});

  // Main loop
  let last=performance.now();
  function loop(now){
    const dt=Math.min(0.033,(now-last)/1000); last=now;
    if(state.stage===0){const log=obstacles[0][0]; const onLog=player.x+player.w>log.x&&player.x<log.x+log.w&&player.onGround;
      if(onLog){state.balance+=Math.sin(now*0.004)*0.4; if(keys.has('ArrowLeft')||keys.has('KeyA')) state.balance-=0.6; if(keys.has('ArrowRight')||keys.has('KeyD')) state.balance+=0.6; state.balance=Math.max(0,Math.min(100,state.balance));
        if(state.balance<5||state.balance>95){player.y=groundY-42;player.x=log.x-40;state.balance=50;toast('Wobble… steady yourself!');}}}
    if(state.stage===1){state.focus=Math.max(0,Math.min(100, state.focus+(keys.has('Space')?45*dt:-25*dt)));}
    if(state.stage===2){state.power=Math.max(0,Math.min(100, state.power+(keys.has('KeyK')?60*dt:-40*dt)));}
    player.step(dt);
    const obs=obstacles[state.stage];
    for(const o of obs){
      if(state.stage===1&&o.type==='spike'){const flashing=Math.floor(now/600)%2===0;
        if(flashing&&aabb({x:player.x,y:player.y,w:player.w,h:player.h},{x:o.x,y:groundY,w:o.w,h:28})){if(state.focus<70){player.x=80;toast('Be still and sharp. (Space to focus)');}}}
      if(state.stage===2){
        if(o.type==='boulder'&&Math.abs(player.x-(o.x))<36&&state.power>65){o.x+=120;toast('Inner power moves mountains!');}
        if(o.type==='gate'&&Math.abs(player.x-(o.x+o.w/2))<40&&state.power>80){o.w=Math.max(0,o.w-160);toast('Gate yields to calm strength.');}}}
    const npc=npcs.find(n=>n.stage===state.stage);
    if(npc&&Math.abs(player.x-npc.x)<40){
      if(state.stage===0&&state.balance>=45&&state.balance<=55){state.lessons++;toast(npc.line);nextStage();}
      else if(state.stage===1&&state.focus>=80){state.lessons++;toast(npc.line);nextStage();}
      else if(state.stage===2&&state.power>=80){state.lessons++;toast(npc.line);nextStage();}
      else if(state.stage===3){toast(npc.line+'\\nCalm. Proud. Strong.'); stopTrack(); playTrack("victory", false);} }
    drawBackground(state.stage);
    drawNPC(npc);
    player.draw(dt);
    hud.lessons.textContent=`${state.lessons}/3`;
    hud.bal.style.width=`${state.balance|0}%`;
    hud.foc.style.width=`${state.focus|0}%`;
    hud.pow.style.width=`${state.power|0}%`;
    requestAnimationFrame(loop);}
  hud.stageName.textContent=stageName(state.stage);
  toast('Stage 1: Cross the log and keep balance ~50%.');
